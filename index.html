<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FFF – Flamingo Feedback</title>
<meta name="theme-color" content="#E20074">

<style>
:root{
--magenta:#E20074;
--bg:#0c0c10;
--section:#141418;
--muted:#777;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}

body{
margin:0;
font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;
background:var(--bg);
color:white;
}

/* HEADER */
.header{
background:var(--bg);
border-bottom:3px solid var(--magenta);
padding:24px 20px 20px 20px;
text-align:center;
position:sticky;
top:0;
z-index:10;
}

.app-title{
font-size:28px;
font-weight:700;
letter-spacing:.5px;
}

.score-display{
font-size:48px;
font-weight:800;
color:var(--magenta);
margin-top:6px;
}

.warnIcon{
position:absolute;
right:20px;
top:30px;
font-size:22px;
display:none;
cursor:pointer;
}

/* CONTAINER */
.container{
max-width:900px;
margin:auto;
padding:24px;
}

/* SECTION */
.section-wrapper{
background:var(--section);
border-left:4px solid var(--magenta);
border-radius:14px;
padding:20px;
margin-bottom:28px;
box-shadow:0 0 18px rgba(226,0,116,0.15);
transition:.3s;
}

.section-wrapper.disabled{
opacity:.35;
border-left-color:#444;
box-shadow:none;
}

.section-title{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:12px;
font-size:20px;
font-weight:600;
}

.toggle-label{
font-size:12px;
color:#aaa;
margin-right:8px;
}

/* SWITCH */
.switch{position:relative;width:44px;height:24px;}
.switch input{opacity:0;width:0;height:0;}
.slider{
position:absolute;inset:0;
background:#555;border-radius:24px;transition:.3s;
}
.slider:before{
content:"";position:absolute;height:18px;width:18px;
left:3px;top:3px;background:white;border-radius:50%;transition:.3s;
}
input:checked + .slider{background:var(--magenta);}
input:checked + .slider:before{transform:translateX(20px);}

/* CARD */
.card{
background:#1c1c22;
border-radius:10px;
padding:14px;
margin-bottom:14px;
}

.task{margin-bottom:8px;font-size:14px;}

.stars{
display:flex;
gap:12px;
}

.star{
font-size:38px;
color:#444;
cursor:pointer;
user-select:none;
transition:.15s;
}

.star.active{
color:var(--magenta);
transform:scale(1.05);
}

/* OVERLAY */
.sheet{
position:fixed;
inset:0;
background:rgba(0,0,0,.6);
display:none;
align-items:flex-end;
}

.sheet.open{display:flex;}

.sheet-inner{
background:#1c1c22;
width:100%;
border-radius:24px 24px 0 0;
padding:24px;
max-height:70%;
overflow:auto;
}

/* FOOTER */
.footer{
position:sticky;
bottom:0;
background:#111;
padding:14px;
display:flex;
gap:10px;
}

button{
flex:1;
padding:16px;
border:none;
border-radius:14px;
background:var(--magenta);
color:white;
font-weight:600;
font-size:16px;
cursor:pointer;
}

/* PRINT */
@media print{
body{background:white;color:black;}

.header{
background:white;
border:none;
text-align:left;
padding:0;
margin-bottom:20px;
}

.app-title{color:black;font-size:26px;}
.score-display{color:#E20074;font-size:34px;}

.section-wrapper{
background:white;
border-left:6px solid #E20074;
box-shadow:none;
opacity:1 !important;
}

.section-title{
border-bottom:2px solid #E20074;
padding-bottom:6px;
}

.footer,.warnIcon,.sheet{display:none !important;}
}
</style>
</head>

<body>

<div class="header">
<div class="app-title">Flamingo Feedback</div>
<div class="score-display" id="scoreDisplay">–</div>
<div class="warnIcon" id="warnIcon">⚠️</div>
</div>

<div class="container" id="app"></div>

<div class="footer">
<button id="exportTxtBtn">Export TXT</button>
<button id="exportPdfBtn">PDF Report</button>
</div>

<div class="sheet" id="sheet">
<div class="sheet-inner">
<h3>Entwicklungsfelder (&lt;70%)</h3>
<div id="sheetContent"></div>
</div>
</div>

<script>

/* STATE */
let state = JSON.parse(localStorage.getItem("vertriebs_state")) || {};
let sectionState = JSON.parse(localStorage.getItem("vertriebs_sections")) || {};

/* STRUCTURE */
const structure = {
"01 CHECK-IN":["Kunden wahrnehmen","Auf Kunden zugehen","Freundlich begrüßen"],
"02 BEDARFSANALYSE":["Fokus auf Kunden","Anliegen aufnehmen"],
"03 ABSCHLUSS":["Abschlussfrage","Buchen"]
};

/* INIT SECTION STATE */
Object.keys(structure).forEach(s=>{
if(sectionState[s]===undefined) sectionState[s]=true;
});

/* METRICS */
function computeMetrics(){
let totalPossible=0,totalAchieved=0,issues=[];
for(let section in structure){
if(!sectionState[section]) continue;
structure[section].forEach(task=>{
let id=section+"_"+task;
let rating=state[id]?.rating||0;
totalPossible+=5;
totalAchieved+=rating;
if(rating>0 && rating/5<0.7){
issues.push({task,percent:(rating/5*100)});
}
});
}
let score= totalPossible===0 ? "-" : ((totalAchieved/totalPossible)*100).toFixed(1)+"%";
issues.sort((a,b)=>a.percent-b.percent);
return {score,issues};
}

/* UPDATE SCORE */
function updateScore(){
let m=computeMetrics();
document.getElementById("scoreDisplay").innerText=m.score;
let warn=document.getElementById("warnIcon");
warn.style.display=m.issues.length?"block":"none";
}

/* TOUCH SAFE STAR HANDLER */
function addStarListener(el,callback){
el.addEventListener("click",callback);
el.addEventListener("touchstart",(e)=>{
e.preventDefault();
callback();
},{passive:false});
}

/* RENDER */
function init(){
const app=document.getElementById("app");

for(let section in structure){

let wrapper=document.createElement("div");
wrapper.className="section-wrapper";
if(!sectionState[section]) wrapper.classList.add("disabled");

let title=document.createElement("div");
title.className="section-title";
title.innerHTML=`${section}`;

let toggleWrap=document.createElement("div");
toggleWrap.style.display="flex";
toggleWrap.style.alignItems="center";

let label=document.createElement("span");
label.className="toggle-label";
label.innerText="In Score";

let switchWrap=document.createElement("label");
switchWrap.className="switch";

let checkbox=document.createElement("input");
checkbox.type="checkbox";
checkbox.checked=sectionState[section];

checkbox.onchange=e=>{
sectionState[section]=e.target.checked;
localStorage.setItem("vertriebs_sections",JSON.stringify(sectionState));
wrapper.classList.toggle("disabled",!e.target.checked);
updateScore();
};

let slider=document.createElement("span");
slider.className="slider";

switchWrap.appendChild(checkbox);
switchWrap.appendChild(slider);
toggleWrap.appendChild(label);
toggleWrap.appendChild(switchWrap);

title.appendChild(toggleWrap);
wrapper.appendChild(title);

structure[section].forEach(task=>{
let id=section+"_"+task;
let entry=state[id]||{rating:0};

let card=document.createElement("div");
card.className="card";

let t=document.createElement("div");
t.className="task";
t.innerText=task;
card.appendChild(t);

let stars=document.createElement("div");
stars.className="stars";

for(let i=1;i<=5;i++){
let s=document.createElement("div");
s.className="star";
if(entry.rating>=i) s.classList.add("active");

addStarListener(s,()=>{
if(!sectionState[section]) return;
state[id]={rating:i};
localStorage.setItem("vertriebs_state",JSON.stringify(state));
[...stars.children].forEach((c,index)=>{
c.classList.toggle("active",index<i);
});
updateScore();
});
stars.appendChild(s);
}

card.appendChild(stars);
wrapper.appendChild(card);
});

app.appendChild(wrapper);
}

updateScore();
}

/* PDF PRINT */
document.getElementById("exportPdfBtn").onclick=function(){
window.print();
};

/* TXT */
document.getElementById("exportTxtBtn").onclick=function(){
let m=computeMetrics();
let blob=new Blob(["Score: "+m.score],{type:"text/plain"});
let link=document.createElement("a");
link.href=URL.createObjectURL(blob);
link.download="report.txt";
link.click();
};

/* OVERLAY */
document.getElementById("warnIcon").onclick=function(){
let m=computeMetrics();
let sheet=document.getElementById("sheet");
let content=document.getElementById("sheetContent");
content.innerHTML="";
m.issues.slice(0,5).forEach(i=>{
content.innerHTML+=`<div>${i.task} – ${i.percent.toFixed(0)}%</div>`;
});
sheet.classList.toggle("open");
};
document.getElementById("sheet").onclick=e=>{
if(e.target.id==="sheet") e.currentTarget.classList.remove("open");
};

/* START */
init();

</script>
</body>
</html>